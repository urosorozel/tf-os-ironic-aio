- name: Add rules
  hosts: localhost
  vars:
    global_host_bridge: aio-network
    global_ironic_bridge: aio-ironic
    iptable_rules:
      - name: "Allow traffic forward between {{global_ironic_bridge}} and {{global_host_bridge}}"
        in_interface: "{{global_ironic_bridge}}"
        out_interface: "{{global_host_bridge}}"
        source: 172.20.200.0/22
        destination: 10.200.0.100/24
        rule_num: 1
      - name: "Allow traffic 169.254.0.0/16 between {{global_ironic_bridge}} and {{global_host_bridge}}"
        in_interface: "{{global_ironic_bridge}}"
        out_interface: "{{global_host_bridge}}"
        source: 169.254.0.0/16
        destination: 10.200.0.100/24
        rule_num: 2
  tasks:

  - name: Add rules
    iptables:
      action: insert
      rule_num: "{{item.rule_num}}"
      chain: FORWARD
      out_interface: "{{item.out_interface}}"
      in_interface: "{{item.in_interface}}"
      source: "{{item.source}}"
      destination: "{{item.destination}}"
      jump: ACCEPT
      comment: "{{item.name}}"
    with_items: "{{iptable_rules}}"
    tags:
      - iptables

 
